<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="portabilis_relacao_escolas" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.210000000000003"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="ano" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="instituicao" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="escola" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select public.fcn_upper(instituicao.nm_instituicao) as nm_instituicao,
       public.fcn_upper(instituicao.nm_responsavel) as nm_responsavel,
       (SELECT educacenso_cod_escola.cod_escola_inep
          FROM modules.educacenso_cod_escola
         WHERE educacenso_cod_escola.cod_escola = escola.cod_escola) AS cod_escola_inep,

      (SELECT COALESCE((SELECT COALESCE (fcn_upper(ps.nome),fcn_upper(juridica.fantasia))
          FROM cadastro.pessoa ps,
               cadastro.juridica
         WHERE escola.ref_idpes = juridica.idpes AND
               juridica.idpes = ps.idpes AND
	       ps.idpes = escola.ref_idpes),(SELECT nm_escola
                                               FROM pmieducar.escola_complemento
                                              WHERE ref_cod_escola = escola.cod_escola))) AS nm_escola,
       instituicao.cep,
       instituicao.cidade,
       instituicao.ref_sigla_uf,
       instituicao.bairro,
       instituicao.logradouro,
       instituicao.numero,
       instituicao.ddd_telefone,
       instituicao.telefone,
       to_char(current_date,'dd/mm/yyyy') AS data_atual,
       to_char(current_timestamp, 'HH24:MI:SS') AS hora_atual,

       (SELECT count(*)
          FROM pmieducar.instituicao,
               pmieducar.escola,
               pmieducar.escola_ano_letivo
         WHERE escola_ano_letivo.ano = $P{ano} AND
               instituicao.cod_instituicao = $P{instituicao} AND
               escola_ano_letivo.ref_cod_escola = escola.cod_escola AND
               (SELECT CASE WHEN $P{escola} = 0 THEN
              	  escola_ano_letivo.ref_cod_escola = escola.cod_escola
                ELSE
              	  escola.cod_escola = $P{escola}
                END) AND
               escola.ref_cod_instituicao = instituicao.cod_instituicao AND
               escola.ativo = 1) as total_escola

  from pmieducar.instituicao,
       pmieducar.escola,
       pmieducar.escola_ano_letivo

where  escola_ano_letivo.ano = $P{ano} AND
       instituicao.cod_instituicao = $P{instituicao} AND
       escola_ano_letivo.ref_cod_escola = escola.cod_escola AND
      (SELECT CASE WHEN $P{escola} = 0 THEN
              	escola_ano_letivo.ref_cod_escola = escola.cod_escola
              ELSE
              	escola.cod_escola = $P{escola}
              END) AND
       escola.ref_cod_instituicao = instituicao.cod_instituicao AND
       escola.ativo = 1

ORDER BY nm_escola]]>
	</queryString>
	<field name="nm_instituicao" class="java.lang.String"/>
	<field name="nm_responsavel" class="java.lang.String"/>
	<field name="cod_escola_inep" class="java.lang.Long"/>
	<field name="nm_escola" class="java.lang.String"/>
	<field name="cep" class="java.math.BigDecimal"/>
	<field name="cidade" class="java.lang.String"/>
	<field name="ref_sigla_uf" class="java.lang.String"/>
	<field name="bairro" class="java.lang.String"/>
	<field name="logradouro" class="java.lang.String"/>
	<field name="numero" class="java.math.BigDecimal"/>
	<field name="ddd_telefone" class="java.math.BigDecimal"/>
	<field name="telefone" class="java.math.BigDecimal"/>
	<field name="data_atual" class="java.lang.String"/>
	<field name="hora_atual" class="java.lang.String"/>
	<field name="total_escola" class="java.lang.Long"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band splitType="Stretch"/>
	</title>
	<pageHeader>
		<band height="131" splitType="Stretch">
			<textField isBlankWhenNull="true">
				<reportElement x="339" y="40" width="133" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{cidade}+" - "+$F{ref_sigla_uf}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="423" y="4" width="126" height="13"/>
				<textElement>
					<font size="7" isBold="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Emissão: "+$F{data_atual}+" "+$F{hora_atual}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="339" y="51" width="84" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["CEP: "+$F{cep}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="80" y="4" width="300" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_instituicao}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="80" y="52" width="257" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Fone/Fax: ("+$F{ddd_telefone}+") "+$F{telefone}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="80" y="28" width="300" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Endereço: "+$F{logradouro}+", "+$F{numero}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="80" y="16" width="300" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_responsavel}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="80" y="40" width="257" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bairro:" +$F{bairro}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="210" y="83" width="137" height="20"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Relação de Escolas]]></text>
			</staticText>
			<staticText>
				<reportElement x="87" y="106" width="42" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<text><![CDATA[Nome]]></text>
			</staticText>
			<staticText>
				<reportElement x="10" y="106" width="56" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<text><![CDATA[Código INEP]]></text>
			</staticText>
			<line>
				<reportElement x="6" y="123" width="541" height="1"/>
			</line>
			<image>
				<reportElement x="13" y="4" width="57" height="46"/>
				<imageExpression class="java.lang.String"><![CDATA["imagens/brasao.jpg"]]></imageExpression>
			</image>
		</band>
	</pageHeader>
	<columnHeader>
		<band splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="16" splitType="Stretch">
			<textField isBlankWhenNull="true">
				<reportElement x="87" y="1" width="260" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_escola}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="11" y="2" width="56" height="13"/>
				<textElement textAlignment="Right">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$F{cod_escola_inep}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="1" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band height="25" splitType="Stretch">
			<staticText>
				<reportElement x="10" y="11" width="77" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Total de escolas:]]></text>
			</staticText>
			<line>
				<reportElement x="6" y="6" width="541" height="1"/>
			</line>
			<textField>
				<reportElement x="88" y="11" width="27" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$F{total_escola}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
