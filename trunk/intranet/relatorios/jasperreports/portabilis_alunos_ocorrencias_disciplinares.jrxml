<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="portabilis_alunos_ocorrencias_disciplinares" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="20"/>
	<property name="ireport.y" value="0"/>
	<parameter name="instituicao" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="escola" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="ano" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="curso" class="java.lang.String">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="serie" class="java.lang.String">
		<defaultValueExpression><![CDATA[new java.lang.Integer(0)]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT public.fcn_upper(nm_instituicao) AS nome_instituicao,

       instituicao.cidade AS cidade_instituicao,

       public.fcn_upper(ref_sigla_uf) AS uf_instituicao,

      (SELECT fcn_upper(substring(logradouro.idtlog from 1 for 1)) ||
              lower(substring(logradouro.idtlog, 2))
         FROM public.logradouro,
              cadastro.juridica,
              cadastro.pessoa ps,
              cadastro.endereco_pessoa
        WHERE juridica.idpes = ps.idpes AND
              ps.idpes = endereco_pessoa.idpes AND
              endereco_pessoa.idlog = logradouro.idlog AND
              juridica.idpes = escola.ref_idpes) AS tipo_logradouro,

      (SELECT logradouro.nome
         FROM public.logradouro,
              cadastro.juridica,
              cadastro.pessoa ps,
              cadastro.endereco_pessoa
        WHERE juridica.idpes = ps.idpes AND
              ps.idpes = endereco_pessoa.idpes AND
              endereco_pessoa.idlog = logradouro.idlog AND
              juridica.idpes = escola.ref_idpes) AS logradouro,

      (SELECT bairro.nome
         FROM public.municipio,
              cadastro.endereco_pessoa,
              cadastro.juridica,
              public.bairro
        WHERE endereco_pessoa.idbai = bairro.idbai AND
              bairro.idmun = municipio.idmun AND
              juridica.idpes = endereco_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS bairro,

      (SELECT municipio.nome
         FROM public.municipio,
              cadastro.endereco_pessoa,
              cadastro.juridica,
              public.bairro
        WHERE endereco_pessoa.idbai = bairro.idbai AND
              bairro.idmun = municipio.idmun AND
              juridica.idpes = endereco_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS municipio,

      (SELECT COALESCE(endereco_pessoa.numero,0)
         FROM cadastro.endereco_pessoa,
              cadastro.juridica
        WHERE juridica.idpes = endereco_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS numero,

      (SELECT municipio.sigla_uf
         FROM public.municipio,
              cadastro.endereco_pessoa,
              cadastro.juridica,
              public.bairro
        WHERE endereco_pessoa.idbai = bairro.idbai AND
              bairro.idmun = municipio.idmun AND
              juridica.idpes = endereco_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS uf_municipio,

     (SELECT min(fone_pessoa.ddd)
         FROM cadastro.fone_pessoa,
              cadastro.juridica
        WHERE juridica.idpes = fone_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS fone_ddd,

     (SELECT to_char(endereco_pessoa.cep, '99999-999')
         FROM cadastro.endereco_pessoa,
              cadastro.juridica
        WHERE juridica.idpes = endereco_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS cep,

     (SELECT min(to_char(fone_pessoa.fone, '9999-9999'))
         FROM cadastro.fone_pessoa,
              cadastro.juridica
        WHERE juridica.idpes = fone_pessoa.idpes AND
              juridica.idpes = escola.ref_idpes) AS fone,

     (SELECT ps.email
         FROM cadastro.pessoa ps,
              cadastro.juridica
        WHERE juridica.idpes = ps.idpes AND
              juridica.idpes = escola.ref_idpes) AS email,

       to_char(CURRENT_DATE,'dd/mm/yyyy') AS data_atual,

       to_char(current_timestamp, 'HH24:MI:SS') AS hora_atual,

	(SELECT pessoa.nome
          FROM cadastro.pessoa,
               cadastro.juridica
         WHERE escola.ref_idpes = juridica.idpes AND
               juridica.idpes = pessoa.idpes) as nm_escola,

	(SELECT serie.nm_serie
	   FROM pmieducar.serie
	  WHERE serie.cod_serie = matricula.ref_ref_cod_serie) as nm_serie,

	(SELECT curso.nm_curso
	   FROM pmieducar.curso
	  WHERE curso.cod_curso = matricula.ref_cod_curso) as nm_curso,

	(SELECT turma.nm_turma
	   FROM pmieducar.turma, pmieducar.matricula_turma
	  WHERE turma.cod_turma = matricula_turma.ref_cod_turma AND
		matricula_turma.ref_cod_matricula = matricula.cod_matricula) as nm_turma,

	aluno.cod_aluno as cod_aluno,

	(SELECT pessoa.nome
          FROM cadastro.pessoa,
               cadastro.fisica
         WHERE aluno.ref_idpes = fisica.idpes AND
               fisica.idpes = pessoa.idpes) as nm_aluno,

	(SELECT tod.nm_tipo
	   FROM pmieducar.tipo_ocorrencia_disciplinar tod
	  WHERE tod.cod_tipo_ocorrencia_disciplinar = mod.ref_cod_tipo_ocorrencia_disciplinar) as tipo_ocorrencia,

       to_char(mod.data_cadastro,'dd/mm/yyyy') AS data_ocorrencia,

       to_char(mod.data_cadastro, 'HH24:MI:SS') AS hora_ocorrencia,

	mod.observacao

  FROM pmieducar.matricula_ocorrencia_disciplinar mod,
       pmieducar.matricula,
       pmieducar.aluno,
       pmieducar.escola,
       pmieducar.instituicao

 WHERE mod.ref_cod_matricula = matricula.cod_matricula and
       matricula.ref_cod_aluno = aluno.cod_aluno AND
       matricula.ativo = 1 AND
       instituicao.cod_instituicao = $P{instituicao} AND
       instituicao.cod_instituicao = escola.ref_cod_instituicao AND
       matricula.ref_ref_cod_escola = escola.cod_escola AND
       escola.cod_escola = $P{escola} AND
       (SELECT CASE WHEN $P{curso} = 0 THEN
                  0 = 0
               ELSE
                    matricula.ref_cod_curso = $P{curso}
               END) AND
	(SELECT CASE WHEN $P{serie} = 0 THEN
                  0 = 0
                ELSE
                    matricula.ref_ref_cod_serie = $P{serie}
                END) AND
       matricula.ano = $P{ano} AND
       matricula.ultima_matricula = 1
ORDER BY nm_escola, nm_aluno, data_ocorrencia]]>
	</queryString>
	<field name="nome_instituicao" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="cidade_instituicao" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="uf_instituicao" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="tipo_logradouro" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="logradouro" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bairro" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="municipio" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="numero" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="uf_municipio" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="fone_ddd" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="cep" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="fone" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="email" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="data_atual" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="hora_atual" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="nm_escola" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="nm_serie" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="nm_curso" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="nm_turma" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="cod_aluno" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="nm_aluno" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="tipo_ocorrencia" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="data_ocorrencia" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="hora_ocorrencia" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="observacao" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<variable name="nm_aluno_1" class="java.lang.Integer" resetType="Page" calculation="Count">
		<variableExpression><![CDATA[$F{nm_aluno}]]></variableExpression>
	</variable>
	<group name="Aluno">
		<groupExpression><![CDATA[$F{cod_aluno}]]></groupExpression>
		<groupHeader>
			<band height="16">
				<textField isStretchWithOverflow="true">
					<reportElement x="35" y="2" width="168" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_aluno}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="203" y="2" width="34" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Curso:]]></text>
				</staticText>
				<textField>
					<reportElement x="234" y="2" width="113" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_curso}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="350" y="2" width="30" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Série:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true">
					<reportElement x="380" y="2" width="62" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_serie}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="443" y="2" width="33" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Turma:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true">
					<reportElement x="476" y="2" width="74" height="13"/>
					<textElement>
						<font size="8"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_turma}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="4" y="2" width="34" height="13"/>
					<textElement>
						<font size="8" isBold="true"/>
					</textElement>
					<text><![CDATA[Aluno:]]></text>
				</staticText>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="12"/>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band splitType="Stretch"/>
	</title>
	<pageHeader>
		<band height="173" splitType="Stretch">
			<staticText>
				<reportElement x="126" y="108" width="297" height="16"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true" isUnderline="false"/>
				</textElement>
				<text><![CDATA[Relação de Ocorrências Disciplinares por Aluno]]></text>
			</staticText>
			<staticText>
				<reportElement x="102" y="16" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true" pdfEncoding="Cp1252" isPdfEmbedded="true"/>
				</textElement>
				<text><![CDATA[SECRETARIA MUNICIPAL DE EDUCAÇÃO E CULTURA]]></text>
			</staticText>
			<textField isBlankWhenNull="true">
				<reportElement x="305" y="64" width="233" height="13" forecolor="#000000"/>
				<textElement>
					<font size="8" isBold="true" isItalic="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["E-mail: "+$F{email}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="40" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Endereço: "+$F{logradouro}+" "+$F{numero}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="28" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nm_escola}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="412" y="4" width="126" height="13"/>
				<textElement>
					<font size="7" isBold="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Emissão: "+$F{data_atual}+" "+$F{hora_atual}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="102" y="4" width="278" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{nome_instituicao}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="464" y="52" width="77" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["CEP: "+$F{cep}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="359" y="52" width="99" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{municipio}+" - "+$F{uf_municipio}]]></textFieldExpression>
			</textField>
			<image>
				<reportElement x="22" y="4" width="57" height="46"/>
				<imageExpression class="java.lang.String"><![CDATA["/home/portabilis/www/ararangua/intranet/imagens/brasao.jpg"]]></imageExpression>
			</image>
			<elementGroup/>
			<elementGroup/>
			<textField>
				<reportElement x="102" y="64" width="201" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Fone/Fax: ("+$F{fone_ddd}+") "+$F{fone}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="178" y="158" width="60" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Data]]></text>
			</staticText>
			<staticText>
				<reportElement x="44" y="158" width="98" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Tipo da Ocorrência]]></text>
			</staticText>
			<staticText>
				<reportElement x="278" y="158" width="59" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Hora]]></text>
			</staticText>
			<staticText>
				<reportElement x="347" y="158" width="111" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Observação]]></text>
			</staticText>
			<textField isBlankWhenNull="true">
				<reportElement x="102" y="52" width="253" height="13"/>
				<textElement>
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bairro:" +$F{bairro}]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="16" splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="18" splitType="Stretch">
			<textField>
				<reportElement x="44" y="2" width="129" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{tipo_ocorrencia}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="178" y="2" width="88" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{data_ocorrencia}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="278" y="2" width="46" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{hora_ocorrencia}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="347" y="2" width="198" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{observacao}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="12" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="17" splitType="Stretch">
			<textField evaluationTime="Report">
				<reportElement x="501" y="2" width="40" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="421" y="2" width="80" height="13"/>
				<textElement textAlignment="Right">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page "+$V{PAGE_NUMBER}+" of"]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="17" splitType="Stretch"/>
	</summary>
</jasperReport>
